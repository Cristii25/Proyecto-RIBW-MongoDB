<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Buscador de Restaurantes</title>
  <style>
    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 6px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
    }

    fieldset {
      margin-bottom: 20px;
    }

    label {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    #resultado {
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <h1>Filtrar Restaurantes</h1>

  <form id="busqueda">
    <fieldset>
      <legend>Incluir ingredientes:</legend>
      <div id="incluir" class="checkbox-grid"></div>
    </fieldset>

    <fieldset>
      <legend>Excluir ingredientes:</legend>
      <div id="excluir" class="checkbox-grid"></div>
    </fieldset>

    <fieldset>
      <legend>Filtrar por tipo de plato:</legend>
      <div id="tipo" class="checkbox-grid"></div>
    </fieldset>

    <fieldset>
      <legend>Opciones adicionales:</legend>
      <label><input type="checkbox" id="filtroVegano"> Solo platos veganos</label><br>
      <label><input type="checkbox" id="filtroSinGluten"> Solo platos sin gluten</label>
    </fieldset>

    <button type="submit">Buscar</button>
    <button type="button" id="limpiar">Limpiar filtros</button>
  </form>

  <div id="resultado"></div>

  <script>
    const tiposDePlato = ["Entrante", "Principal", "Postre", "GuarniciÃ³n", "Bebida"];

    async function cargarIngredientes() {
      const res = await fetch("/ingredientes");
      const ingredientes = await res.json();
      ingredientes.sort((a, b) => a.localeCompare(b));

      const incluirDiv = document.getElementById("incluir");
      const excluirDiv = document.getElementById("excluir");
      const tipoDiv = document.getElementById("tipo");

      ingredientes.forEach(ing => {
        const checkboxIncluir = document.createElement("label");
        checkboxIncluir.innerHTML = `<input type="checkbox" name="incluir" value="${ing}"> ${ing}`;
        incluirDiv.appendChild(checkboxIncluir);

        const checkboxExcluir = document.createElement("label");
        checkboxExcluir.innerHTML = `<input type="checkbox" name="excluir" value="${ing}"> ${ing}`;
        excluirDiv.appendChild(checkboxExcluir);
      });

      tiposDePlato.forEach(tipo => {
        const checkboxTipo = document.createElement("label");
        checkboxTipo.innerHTML = `<input type="checkbox" name="tipo" value="${tipo}"> ${tipo}`;
        tipoDiv.appendChild(checkboxTipo);
      });
    }

    async function buscar() {
      const incluir = Array.from(document.querySelectorAll('input[name="incluir"]:checked')).map(cb => cb.value);
      const excluir = Array.from(document.querySelectorAll('input[name="excluir"]:checked')).map(cb => cb.value);
      const tipo = Array.from(document.querySelectorAll('input[name="tipo"]:checked')).map(cb => cb.value);
      const vegano = document.getElementById("filtroVegano").checked;
      const sinGluten = document.getElementById("filtroSinGluten").checked;

      const res = await fetch("/buscar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ incluir, excluir, tipo, vegano, sinGluten })
      });

      const data = await res.json();
      const div = document.getElementById("resultado");

      if (data.length === 0) {
        div.innerHTML = "<p>No se encontraron restaurantes.</p>";
      } else {
        div.innerHTML = data.map(r =>
          `<h3>${r._id}</h3><ul>${r.platos.map(p =>
            `<li><strong>${p.nombre}</strong> â€“ ${p.ingredientes.join(", ")}${p.vegano ? " ðŸ¥¦" : ""}${p.sin_gluten ? " ðŸš« gluten" : ""}</li>`
          ).join("")}</ul>`
        ).join("");
      }
    }

    document.getElementById("busqueda").addEventListener("submit", async (e) => {
      e.preventDefault();
      await buscar();
    });

    document.getElementById("limpiar").addEventListener("click", async () => {
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      await buscar();
    });

    cargarIngredientes();
  </script>
</body>
</html>
