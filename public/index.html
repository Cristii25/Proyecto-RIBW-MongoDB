<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Buscador de Restaurantes</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>Busca tu comida</h1>

  <form id="busqueda">
    <fieldset>
      <legend>Nombre del restaurante:</legend>
      <select id="nombreRestaurante">
        <option value="">-- Todos --</option>
      </select>
    </fieldset>

    <fieldset>
      <legend>Incluir ingredientes:</legend>
      <div id="incluir" class="checkbox-grid"></div>
    </fieldset>

    <fieldset>
      <legend>Excluir ingredientes:</legend>
      <div id="excluir" class="checkbox-grid"></div>
    </fieldset>

    <fieldset>
      <legend>Filtrar por tipo de plato:</legend>
      <div id="tipo" class="checkbox-grid"></div>
    </fieldset>

    <fieldset>
      <legend>Filtrar por familia:</legend>
      <div id="familia" class="checkbox-grid"></div>
    </fieldset>

    <fieldset>
      <legend>Opciones adicionales:</legend>
      <label><input type="checkbox" id="filtroVegano"> Solo platos veganos</label><br>
      <label><input type="checkbox" id="filtroSinGluten"> Solo platos sin gluten</label>
    </fieldset>

    <fieldset>
      <legend>Ordenar por precio:</legend>
      <select id="ordenPrecio">
        <option value="">-- Ninguno --</option>
        <option value="asc">Menor a mayor</option>
        <option value="desc">Mayor a menor</option>
      </select>
    </fieldset>

    <button type="submit">Buscar</button>
    <button type="button" id="limpiar">Limpiar filtros</button>
  </form>

  <div id="resultado"></div>

  <script>
    const tiposDePlato = ["Entrante", "Principal", "Postre", "GuarniciÃ³n", "Bebida"];
    const familias = ["carne", "mariscos", "vegetal", "dulce", "pescado", "lÃ¡cteos"];

    async function cargarIngredientes() {
      const [resIngredientes, resRestaurantes] = await Promise.all([
        fetch("/ingredientes"),
        fetch("/restaurantes")
      ]);

      const ingredientes = await resIngredientes.json();
      const restaurantes = await resRestaurantes.json();
      ingredientes.sort((a, b) => a.localeCompare(b));
      restaurantes.sort((a, b) => a.localeCompare(b));

      const incluirDiv = document.getElementById("incluir");
      const excluirDiv = document.getElementById("excluir");
      const tipoDiv = document.getElementById("tipo");
      const familiaDiv = document.getElementById("familia");
      const selectRestaurante = document.getElementById("nombreRestaurante");

      ingredientes.forEach(ing => {
        incluirDiv.innerHTML += `<label><input type="checkbox" name="incluir" value="${ing}"> ${ing}</label>`;
        excluirDiv.innerHTML += `<label><input type="checkbox" name="excluir" value="${ing}"> ${ing}</label>`;
      });

      tiposDePlato.forEach(tipo => {
        tipoDiv.innerHTML += `<label><input type="checkbox" name="tipo" value="${tipo}"> ${tipo}</label>`;
      });

      familias.forEach(fam => {
        familiaDiv.innerHTML += `<label><input type="checkbox" name="familia" value="${fam}"> ${fam}</label>`;
      });

      restaurantes.forEach(nombre => {
        selectRestaurante.innerHTML += `<option value="${nombre}">${nombre}</option>`;
      });
    }

    async function buscar() {
      const nombreRestaurante = document.getElementById("nombreRestaurante").value;
      const incluir = Array.from(document.querySelectorAll('input[name="incluir"]:checked')).map(cb => cb.value);
      const excluir = Array.from(document.querySelectorAll('input[name="excluir"]:checked')).map(cb => cb.value);
      const tipo = Array.from(document.querySelectorAll('input[name="tipo"]:checked')).map(cb => cb.value);
      const familia = Array.from(document.querySelectorAll('input[name="familia"]:checked')).map(cb => cb.value);
      const vegano = document.getElementById("filtroVegano").checked;
      const sinGluten = document.getElementById("filtroSinGluten").checked;
      const ordenPrecio = document.getElementById("ordenPrecio").value;

      const res = await fetch("/buscar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nombreRestaurante, incluir, excluir, tipo, familia, vegano, sinGluten, ordenPrecio })
      });

      const data = await res.json();
      const div = document.getElementById("resultado");

      div.innerHTML = data.length === 0
        ? "<p>No se encontraron restaurantes.</p>"
        : data.map(r =>
            `<h3>${r._id}</h3><ul>${r.platos.map(p =>
              `<li><strong>${p.nombre}</strong> â€“ ${p.precio.toFixed(2)}â‚¬ â€“ ${p.ingredientes.join(", ")}${p.vegano ? " ðŸ¥¦" : ""}${p.sin_gluten ? " ðŸš« gluten" : ""}</li>`
            ).join("")}</ul>`
          ).join("");
    }

    document.getElementById("busqueda").addEventListener("submit", async (e) => {
      e.preventDefault();
      await buscar();
    });

    document.getElementById("limpiar").addEventListener("click", async () => {
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      document.getElementById("ordenPrecio").value = "";
      document.getElementById("nombreRestaurante").value = "";
      await buscar();
    });

    cargarIngredientes();
  </script>
</body>
</html>
